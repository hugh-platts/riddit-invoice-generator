<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Image Watermark with QR Code - RIDDITHOMES.COM</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2rem;
    }

    #preview-container {
      margin-top: 1rem;
    }

    #preview {
      max-width: 100%;
      height: auto;
      display: none;
      border: 1px solid #ccc;
    }

    #download-btn {
      margin-top: 1rem;
      display: none;
    }
  </style>
</head>
<body>
  <h1>Image Watermark + QR Code</h1>
  <p>
    Upload an image to add a <strong>“RIDDITHOMES.COM”</strong> watermark and optionally a QR code pointing to <strong>https://riddithomes.com</strong>.
  </p>

  <!-- File input allowing .heic, .jpeg, .jpg, and .png -->
  <input
    type="file"
    id="image-input"
    accept="image/heic, image/jpeg, image/jpg, image/png"
  />
  <br/><br/>

  <!-- Checkbox to add QR code for riddithomes.com -->
  <label>
    <input type="checkbox" id="qr-checkbox" />
    Include QR Code for riddithomes.com
  </label>
  <br/><br/>

  <!-- Checkbox to toggle watermark text color (white or black) -->
  <label>
    <input type="checkbox" id="black-watermark-checkbox" />
    Use Black Watermark Text
  </label>

  <div id="preview-container">
    <img id="preview" alt="Preview" />
  </div>

  <!-- Button to download watermarked image. Initially hidden. -->
  <button id="download-btn">Download Watermarked Image</button>

  <!-- Include a QR code generation library from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

  <script>
    const imageInput = document.getElementById('image-input');
    const preview = document.getElementById('preview');
    const downloadBtn = document.getElementById('download-btn');
    const qrCheckbox = document.getElementById('qr-checkbox');
    const blackWatermarkCheckbox = document.getElementById('black-watermark-checkbox');

    let watermarkedImageURL = null; // will store the data URL of the watermarked image

    imageInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) {
        return;
      }

      // Validate file type
      const validTypes = ['image/heic', 'image/jpeg', 'image/jpg', 'image/png'];
      if (!validTypes.includes(file.type)) {
        alert('Please upload a valid image file (HEIC, JPEG, JPG, or PNG).');
        return;
      }

      // Read the file as a data URL
      const reader = new FileReader();
      reader.onload = async function(event) {
        const dataURL = event.target.result;
        
        // Create an Image object for the uploaded image
        const img = new Image();
        img.onload = async function() {
          // Create a canvas with the same dimensions as the uploaded image
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext('2d');

          // Draw the user's image onto the canvas
          ctx.drawImage(img, 0, 0);

          // ===== 1) WATERMARK TEXT =====
          // Determine font size (e.g., 4% of canvas width)
          const fontSize = Math.floor(canvas.width * 0.04);
          ctx.font = `${fontSize}px Arial`;
          ctx.textAlign = 'right';
          ctx.textBaseline = 'bottom';

          // Pick color: black or white, based on the checkbox
          if (blackWatermarkCheckbox.checked) {
            // Semi-transparent black
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
          } else {
            // Semi-transparent white
            ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
          }

          // Draw the watermark text near the bottom-right corner
          ctx.fillText('RIDDITHOMES.COM', canvas.width - 10, canvas.height - 10);

          // ===== 2) OPTIONAL QR CODE =====
          if (qrCheckbox.checked) {
            // Generate a small QR code (width ~10% of image width)
            const qrSize = Math.floor(canvas.width * 0.1);
            
            // Generate QR code data URL pointing to https://riddithomes.com
            let qrCodeDataURL;
            try {
              qrCodeDataURL = await QRCode.toDataURL('https://riddithomes.com', {
                width: qrSize,
                margin: 0,
              });
            } catch (qrErr) {
              console.error('QR Code Generation Error:', qrErr);
              alert('Error generating QR code. Check console for more details.');
              return;
            }

            // Create an image from the QR code data URL
            const qrImg = new Image();
            qrImg.onload = function() {
              // Draw the QR code in the bottom-left corner with some margin
              const margin = 10;
              ctx.drawImage(qrImg, margin, canvas.height - qrImg.height - margin);
              
              // Convert final canvas to data URL, then show preview & download
              finishCanvas(canvas);
            };
            qrImg.src = qrCodeDataURL;
          } else {
            // No QR code, just finish the canvas
            finishCanvas(canvas);
          }

          function finishCanvas(cv) {
            // Convert final canvas to data URL
            watermarkedImageURL = cv.toDataURL('image/png');
            // Show the preview image
            preview.src = watermarkedImageURL;
            preview.style.display = 'block';
            // Show the download button
            downloadBtn.style.display = 'inline-block';
          }
        };

        // Set image source for load
        img.src = dataURL;
      };
      reader.readAsDataURL(file);
    });

    // Allow user to download the watermarked image
    downloadBtn.addEventListener('click', () => {
      if (!watermarkedImageURL) return;

      // Create a temporary link and trigger download
      const link = document.createElement('a');
      link.href = watermarkedImageURL;
      link.download = 'watermarked_RIDDITHOMES.png';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
  </script>
</body>
</html>
